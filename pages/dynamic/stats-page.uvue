<template>
	<scroll-view class="root">
		<view class="container">

			<!-- æ—¶é—´ç­›é€‰ & æ¦‚è§ˆ -->
			<view class="filter-section">
				<view class="time-filter">
					<text v-for="(item, idx) in timeTabs" :key="idx" class="filter-option"
						:class="{ active: idx === activeTime }" @tap="activeTime = idx">
						{{ item }}
					</text>
				</view>

				<view class="overview-cards">
					<view class="overview-card">
						<text class="overview-value">{{ overview.hours }}h</text>
						<text class="overview-label">å­¦ä¹ æ—¶é•¿</text>
					</view>
					<view class="overview-card">
						<text class="overview-value">{{ overview.total }}</text>
						<text class="overview-label">åšé¢˜æ€»é‡</text>
					</view>
					<view class="overview-card overview-card-last">
						<text class="overview-value">{{ overview.rate }}%</text>
						<text class="overview-label">å¹³å‡æ­£ç¡®ç‡</text>
					</view>
				</view>
			</view>

			<!-- æ­£ç¡®ç‡è¶‹åŠ¿å›¾ -->
			<view class="chart-section">
				<text class="section-title">æ­£ç¡®ç‡è¶‹åŠ¿</text>
				<view class="chart-container">
					<view v-for="(bar, idx) in trend" :key="idx" class="chart-bar" :style="{ height: bar.height }"
						@tap="showDetail(bar)">
						<text class="chart-value">{{ bar.rate }}%</text>
						<text class="chart-bar-label">{{ bar.day }}</text>
					</view>
				</view>
				<view class="chart-insight">
					<text class="insight-icon iconfont icon-linechart"></text>
					<text>æ‚¨çš„æ­£ç¡®ç‡å‘ˆä¸Šå‡è¶‹åŠ¿ï¼Œæœ€è¿‘ä¸‰å¤©è¡¨ç°ä¼˜å¼‚ï¼</text>
				</view>
			</view>

			<!-- å­¦ç§‘èƒ½åŠ›åˆ†æ -->
			<view class="subject-section">
				<text class="section-title">å­¦ç§‘èƒ½åŠ›åˆ†æ</text>
				<view v-for="(s, idx) in subjects" :key="idx" class="subject-item"
					:class="{'subject-item-last': idx === subjects.length - 1}">
					<text class="subject-name">{{ s.name }}</text>
					<view class="progress-container">
						<view class="progress-bar" :style="{ width: s.rate + '%' }" />
					</view>
					<text class="subject-score">{{ s.rate }}%</text>
					<button class="practice-button" @tap="goPractice(s.name)">ç»ƒä¹ </button>
				</view>
			</view>

			<!-- çŸ¥è¯†ç‚¹æŒæ¡ -->
			<view class="knowledge-section">
				<text class="section-title">çŸ¥è¯†ç‚¹æŒæ¡åˆ†æ</text>
				<scroll-view class="subject-selector">
					<text v-for="(tab, idx) in knowledgeTabs" :key="idx" class="subject-tab"
						:class="{ active: idx === activeKnowledge }" @tap="activeKnowledge = idx">
						{{ tab }}
					</text>
				</scroll-view>

				<view>
					<view v-for="(k, idx) in currentKnowledge" :key="idx" class="knowledge-item">
						<text class="knowledge-name">{{ k.name }}</text>
						<view class="knowledge-progress">
							<view class="progress-ring" :data-rate="k.rate">
								<text class="progress-text">{{ k.rate }}%</text>
							</view>
						</view>
						<button class="consolidate-button" @tap="goConsolidate(k.name)">å»å·©å›º</button>
					</view>
				</view>
			</view>

			<!-- å­¦ä¹ æ—¶é—´åˆ†å¸ƒ -->
			<view class="time-section">
				<text class="section-title">å­¦ä¹ æ—¶é—´åˆ†å¸ƒ</text>
				<view class="time-chart">
					<view v-for="(bar, idx) in timeDist" :key="idx" class="time-bar" :style="{ height: bar.height }">
						<text class="time-value">{{ bar.hours }}h</text>
						<text class="time-label">{{ bar.day }}</text>
					</view>
				</view>
				<view class="chart-insight">
					<text class="insight-icon iconfont icon-time-circle"></text>
					<text>å‘¨ä¸‰è‡³å‘¨äº”å­¦ä¹ æ—¶é—´è¾ƒé•¿ï¼Œå‘¨æœ«å¯é€‚å½“å¢åŠ ã€‚</text>
				</view>
			</view>

			<!-- å­¦ä¹ æŠ¥å‘Šä¸å»ºè®® -->
			<view class="report-section">
				<text class="section-title">å­¦ä¹ æŠ¥å‘Šä¸å»ºè®®</text>
				<view class="report-content">
					è¿‡å»ä¸€å‘¨æ‚¨å…±å­¦ä¹ äº†28å°æ—¶ï¼Œæ­£ç¡®ç‡ç¨³æ­¥æå‡ï¼æ•°å­¦æ˜¯ä¼˜åŠ¿ç§‘ç›®ï¼Œä½†è‹±è¯­éœ€åŠ å¼ºï¼Œç‰¹åˆ«æ˜¯é˜…è¯»ç†è§£ã€‚å»ºè®®æ¯å¤©å¢åŠ 30åˆ†é’Ÿè‹±è¯­ä¸“é¡¹ç»ƒä¹ ã€‚
				</view>
				<button class="report-button" @tap="handleReport">
					<text>{{ generating ? 'ç”Ÿæˆä¸­...' : 'ç”Ÿæˆå®Œæ•´å­¦ä¹ æŠ¥å‘Š' }}</text>
					<text class="icon">ğŸ“¥</text>
				</button>
			</view>

			<BottomNav current="statistics" />
		</view>
	</scroll-view>
</template>

<script setup lang="uts">
	import { ref, computed } from 'vue'

	/* æ—¶é—´ç­›é€‰ */
	const timeTabs = ['æœ¬æ—¥', 'æœ¬å‘¨', 'æœ¬æœˆ', 'å…¨éƒ¨']
	const activeTime = ref(1)

	/* æ¦‚è§ˆæ•°æ® */
	const overview = ref({
		hours: 28,
		total: 500,
		rate: 75
	})

	/* æ­£ç¡®ç‡è¶‹åŠ¿ */
	const trend = ref([
		{ day: 'å‘¨ä¸€', rate: 70, height: '70%' },
		{ day: 'å‘¨äºŒ', rate: 65, height: '65%' },
		{ day: 'å‘¨ä¸‰', rate: 80, height: '80%' },
		{ day: 'å‘¨å››', rate: 75, height: '75%' },
		{ day: 'å‘¨äº”', rate: 85, height: '85%' },
		{ day: 'å‘¨å…­', rate: 90, height: '90%' },
		{ day: 'å‘¨æ—¥', rate: 78, height: '78%' }
	])

	/* å­¦ç§‘èƒ½åŠ› */
	const subjects = ref([
		{ name: 'æ•°å­¦', rate: 85 },
		{ name: 'è‹±è¯­', rate: 65 },
		{ name: 'è¯­æ–‡', rate: 90 }
	])

	/* çŸ¥è¯†ç‚¹ */
	const knowledgeTabs = ['æ•°å­¦', 'è‹±è¯­', 'è¯­æ–‡', 'ç‰©ç†', 'åŒ–å­¦']
	const activeKnowledge = ref(0)

	const knowledgeData = ref({
		æ•°å­¦: [
			{ name: 'å‡½æ•°ä¸“é¢˜', rate: 45 },
			{ name: 'å‡ ä½•è¯æ˜', rate: 70 },
			{ name: 'ä»£æ•°è¿ç®—', rate: 85 }
		],
		è‹±è¯­: [
			{ name: 'é˜…è¯»ç†è§£', rate: 60 },
			{ name: 'å®Œå½¢å¡«ç©º', rate: 75 },
			{ name: 'å†™ä½œ', rate: 80 }
		]
	})

	const currentKnowledge = computed(() => knowledgeData.value[knowledgeTabs[activeKnowledge.value]] || [])

	/* å­¦ä¹ æ—¶é—´åˆ†å¸ƒ */
	const timeDist = ref([
		{ day: 'å‘¨ä¸€', hours: 2, height: '40%' },
		{ day: 'å‘¨äºŒ', hours: 3, height: '60%' },
		{ day: 'å‘¨ä¸‰', hours: 4, height: '80%' },
		{ day: 'å‘¨å››', hours: 3.5, height: '70%' },
		{ day: 'å‘¨äº”', hours: 4.5, height: '90%' },
		{ day: 'å‘¨å…­', hours: 2.5, height: '50%' },
		{ day: 'å‘¨æ—¥', hours: 1.5, height: '30%' }
	])

	/* æŠ¥å‘Šç”Ÿæˆ */
	const generating = ref(false)
	const handleReport = () => {
		generating.value = true
		setTimeout(() => {
			generating.value = false
			uni.showToast({ title: 'æŠ¥å‘Šå·²ç”Ÿæˆ', icon: 'success' })
		}, 1500)
	}

	/* è·³è½¬ */
	const goPractice = (subject : string) => uni.showToast({ title: `ç»ƒä¹ ${subject}`, icon: 'none' })
	const goConsolidate = (point : string) => uni.showToast({ title: `å·©å›º${point}`, icon: 'none' })
	const showDetail = (bar : any) => uni.showToast({ title: `${bar.day} ${bar.rate}%`, icon: 'none' })
</script>

<style>
	.root {
		flex: 1;
		background: linear-gradient(to bottom right, #f8f9fc, #eef0f8);
	}

	.container {
		padding: 32rpx 32rpx 120rpx;
	}

	/* é€šç”¨å¡ç‰‡ */
	.filter-section,
	.chart-section,
	.subject-section,
	.knowledge-section,
	.time-section,
	.report-section {
		background: linear-gradient(to bottom, #fff, #f8f9fc);
		border-radius: 40rpx;
		padding: 40rpx;
		margin-bottom: 32rpx;
		border: 2rpx solid #e6e9f0;
	}

	.section-title {
		font-size: 36rpx;
		font-weight: bold;
		color: #3a397a;
		margin-bottom: 32rpx;
	}

	/* æ—¶é—´ç­›é€‰ */
	.time-filter {
		flex-direction: row;
		justify-content: space-between;
		margin-bottom: 40rpx;
	}

	.filter-option {
		padding: 16rpx 32rpx;
		border-radius: 40rpx;
		font-size: 28rpx;
		background-color: #f0f2f7;
		color: #6c757d;
		border: 2rpx solid #e6e9f0;
	}

	.filter-option.active {
		background: linear-gradient(to bottom right, #3a397a, #4f4e8c);
		color: #fff;
		border-color: #2f2e62;
	}

	/* æ¦‚è§ˆå¡ç‰‡ */
	.overview-cards {
		flex-direction: row;
	}

	.overview-card {
		flex: 1;
		align-items: center;
		padding: 24rpx;
		background-color: #f8f9fc;
		border-radius: 32rpx;
		margin-right: 16rpx;
		border: 2rpx solid #e6e9f0;
	}

	.overview-card-last {
		margin-right: 0;
	}

	.overview-value {
		font-size: 40rpx;
		font-weight: bold;
		color: #3a397a;
		margin-bottom: 8rpx;
	}

	.overview-label {
		font-size: 24rpx;
		color: #6c757d;
	}

	/* å›¾è¡¨å®¹å™¨ */
	.chart-container,
	.time-chart {
		flex-direction: row;
		align-items: flex-end;
		justify-content: space-around;
		height: 400rpx;
		padding: 40rpx 0;
		border-bottom: 2rpx solid #e6e9f0;
		margin-bottom: 32rpx;
	}

	.chart-bar,
	.time-bar {
		width: 60rpx;
		background: linear-gradient(to top, #3a397a, #6a69b3);
		border-radius: 12rpx 12rpx 0 0;
		position: relative;
	}

	.chart-value,
	.time-value {
		position: absolute;
		top: -40rpx;
		left: 0;
		right: 0;
		text-align: center;
		font-size: 24rpx;
		font-weight: bold;
		color: #3a397a;
	}

	.chart-bar-label,
	.time-label {
		position: absolute;
		bottom: -40rpx;
		left: 0;
		right: 0;
		text-align: center;
		font-size: 24rpx;
		color: #6c757d;
	}

	.chart-insight {
		flex-direction: row;
		align-items: center;
		background-color: #f0f2f7;
		padding: 24rpx;
		border-radius: 24rpx;
		font-size: 28rpx;
		border: 2rpx solid #e6e9f0;
	}

	.insight-icon {
		margin-right: 16rpx;
	}

	/* å­¦ç§‘èƒ½åŠ› */
	.subject-item {
		flex-direction: row;
		align-items: center;
		margin-bottom: 32rpx;
	}

	.subject-item-last {
		margin-bottom: 0;
	}

	.subject-name {
		width: 120rpx;
		font-size: 28rpx;
		font-weight: bold;
		color: #2c2c2c;
	}

	.progress-container {
		flex: 1;
		height: 24rpx;
		background-color: #f0f2f7;
		border-radius: 12rpx;
		overflow: hidden;
		margin: 0 24rpx;
		border: 2rpx solid #e6e9f0;
	}

	.progress-bar {
		height: 100%;
		background: linear-gradient(to right, #3a397a, #6a69b3);
		border-radius: 12rpx;
	}

	.subject-score {
		width: 80rpx;
		text-align: right;
		font-size: 28rpx;
		font-weight: bold;
		color: #3a397a;
	}

	/* çŸ¥è¯†ç‚¹ */
	.subject-selector {
		flex-direction: row;
		margin-bottom: 32rpx;
	}

	.subject-tab {
		padding: 16rpx 32rpx;
		border-radius: 40rpx;
		font-size: 28rpx;
		background-color: #f0f2f7;
		color: #6c757d;
		margin-right: 16rpx;
		white-space: nowrap;
		border: 2rpx solid #e6e9f0;
	}

	.subject-tab.active {
		background: linear-gradient(to bottom right, #3a397a, #4f4e8c);
		color: #fff;
		border-color: #2f2e62;
	}

	.knowledge-item {
		flex-direction: row;
		align-items: center;
		justify-content: space-between;
		padding: 24rpx 0;
		border-bottom: 2rpx solid #e6e9f0;
	}

	.knowledge-item:last-child {
		border-bottom: none;
	}

	.knowledge-name {
		font-size: 28rpx;
		color: #2c2c2c;
		flex: 1;
	}

	.knowledge-progress {
		width: 120rpx;
		height: 120rpx;
		position: relative;
		justify-content: center;
		align-items: center;
	}

	.progress-ring {
		width: 100%;
		height: 100%;
		border-radius: 120rpx;
		background: conic-gradient(#3a397a var(--progress, 0deg), #f0f2f7 0deg);
	}

	.progress-text {
		position: absolute;
		font-size: 24rpx;
		font-weight: bold;
		color: #3a397a;
	}

	/* æŒ‰é’® */
	.practice-button,
	.consolidate-button {
		padding: 12rpx 24rpx;
		border-radius: 16rpx;
		font-size: 24rpx;
		font-weight: bold;
		border: 2rpx solid transparent;
	}

	.practice-button {
		background: linear-gradient(to bottom right, #3a397a, #4f4e8c);
		color: #fff;
		border-color: #2f2e62;
	}

	.consolidate-button {
		background: linear-gradient(to bottom right, #ff7e5f, #ff9a8b);
		color: #fff;
		border-color: #e25b3b;
	}

	/* æŠ¥å‘ŠåŒºåŸŸ */
	.report-content {
		background-color: #f0f2f7;
		padding: 32rpx;
		border-radius: 24rpx;
		margin-bottom: 32rpx;
		font-size: 28rpx;
		line-height: 1.5;
		border: 2rpx solid #e6e9f0;
	}

	.report-button {
		width: 100%;
		padding: 32rpx;
		background: linear-gradient(to bottom right, #3a397a, #4f4e8c);
		color: #fff;
		border-radius: 24rpx;
		font-size: 32rpx;
		font-weight: bold;
		border: 2rpx solid #2f2e62;
	}

	.report-button .icon {
		margin-left: 8rpx;
	}
</style>