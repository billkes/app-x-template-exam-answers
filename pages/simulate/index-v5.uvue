<template>
	<view class="page">
		<!-- é¡µé¢å®¹å™¨ï¼šæ»šåŠ¨è§†å›¾ -->
		<scroll-view class="page-scroll">
			<view class="page-scroll-view">
				<!-- å¤´éƒ¨ä¿¡æ¯åŒºåŸŸ -->
				<view class="header">
					<!-- æ ‡é¢˜è¡Œ -->
					<view class="title-row">
						<text class="title">ğŸ“ å‰ç«¯å¼€å‘å·¥ç¨‹å¸ˆè®¤è¯è€ƒè¯•</text>
					</view>

					<!-- è€ƒè¯•ä¿¡æ¯è¡Œ -->
					<view class="info-row">
						<text class="info-row-text">è€ƒè¯•æ—¶é—´: 120åˆ†é’Ÿ</text>
						<!-- åŠ¨æ€æ˜¾ç¤ºæ ¼å¼åŒ–åçš„å‰©ä½™æ—¶é—´ -->
						<text class="info-row-text">å‰©ä½™æ—¶é—´: {{ formattedTime }}</text>
					</view>

					<!-- è¿›åº¦æ¡åŒºåŸŸ -->
					<view class="progress-wrap">
						<!-- è¿›åº¦æ¡èƒŒæ™¯ -->
						<view class="progress-bar">
							<!-- åŠ¨æ€è¿›åº¦å¡«å……æ¡ï¼ˆæ ¹æ®progressè®¡ç®—å®½åº¦ï¼‰ -->
							<view class="progress-fill" :style="{ width: progress + '%' }" />
						</view>
						<!-- è¿›åº¦ä¿¡æ¯ -->
						<view class="progress-info">
							<text class="progress-info-text">å·²å®Œæˆ {{ progress }}%</text>
							<text class="progress-info-text">{{ answered }}/{{ questions.length }} é¢˜</text>
						</view>
					</view>
				</view>

				<!-- ç­”é¢˜å¡ï¼šå¯å±•å¼€æ”¶èµ· -->
				<view class="card">
					<!-- ç­”é¢˜å¡å¤´éƒ¨ï¼ˆç‚¹å‡»å¯å±•å¼€/æ”¶èµ·ï¼‰ -->
					<view class="card-header" @tap="toggleExpand">
						<text class="card-title">ğŸ”¢ ç­”é¢˜å¡</text>
						<!-- åŠ¨æ€æ—‹è½¬ç®­å¤´ï¼ˆæ ¹æ®å±•å¼€çŠ¶æ€ï¼‰ -->
						<text class="arrow" :class="{ up: expanded }">â–¼</text>
					</view>

					<!-- ç­”é¢˜å¡ä¸»ä½“ï¼ˆå±•å¼€æ—¶æ˜¾ç¤ºï¼‰ -->
					<view v-if="expanded" class="card-body">
						<view class="grid">
							<!-- éå†ç”Ÿæˆæ‰€æœ‰é¢˜ç›®çš„ç­”é¢˜å¡æŒ‰é’® -->
							<!-- åŠ¨æ€æŒ‰é’®æ ·å¼ï¼šå½“å‰é¢˜/å·²ç­”é¢˜/æœªç­”é¢˜ -->
							<view v-for="(item, idx) in questions.length" :key="idx" :class="questions[idx].id === current ? 'btn-current' : isAnswered(idx) ? 'btn-answered' :
								'btn'" @tap="handleJump(idx)">
								<!-- æŒ‰é’®æ–‡æœ¬æ ·å¼ -->
								<text
									:class="questions[idx].id === current ? 'btn-text-current' : isAnswered(idx) ? 'btn-text-answered' : 'btn-text'">{{ item }}</text>
							</view>
						</view>
					</view>
				</view>

				<!-- é¢˜ç›®åŒºåŸŸ -->
				<view class="question-card" v-if="current !== ''">
					<!-- é¢˜ç›®å¤´éƒ¨ä¿¡æ¯ -->
					<view class="question-header">
						<!-- æ˜¾ç¤ºé¢˜ç›®ç±»å‹ï¼ˆå•é€‰/å¤šé€‰ï¼‰ -->
						<text class="type">{{ questionType }}</text>
						<!-- æ˜¾ç¤ºé¢˜ç›®åˆ†å€¼ -->
						<text class="score">{{ questionScore }}</text>
					</view>
					<!-- é¢˜ç›®æ–‡æœ¬ï¼ˆæ˜¾ç¤ºé¢˜å·å’Œé¢˜å¹²ï¼‰ -->
					<text class="question-text">
						{{ questions.findIndex(q=>q.id === current) + 1 }}. {{ stem }}
					</text>

					<!-- é€‰é¡¹åŒºåŸŸ -->
					<view class="options">
						<!-- éå†ç”Ÿæˆé€‰é¡¹ -->
						<!-- åŠ¨æ€é€‰é¡¹æ ·å¼ï¼ˆæ˜¯å¦è¢«é€‰ä¸­ï¼‰ -->
						<view v-for="(opt, idx) in options" :key="idx" class="option"
							:class="{ selected: isSelected(optKey[idx]) }" @tap="handleSelect(optKey[idx])">
							<!-- é€‰é¡¹æ ‡è®°ï¼ˆA/B/C/D...ï¼‰ -->
							<view class="marker">
								<text class="marker-text">
									{{ optKey[idx] }}
								</text>
							</view>
							<!-- é€‰é¡¹æ–‡æœ¬å†…å®¹ -->
							<text class="text">{{ opt }}</text>
							<!-- å¤šé€‰é¢˜é€‰ä¸­æ ‡è®°ï¼ˆåªåœ¨å¤šé€‰é¢˜ä¸”é€‰ä¸­æ—¶æ˜¾ç¤ºï¼‰ -->
							<view v-if="currentQuestion.type === 'multiple' && isSelected(optKey[idx])"
								class="multi-select-mark">
								<text class="multi-select-mark-text">âœ“</text>
							</view>
						</view>
					</view>

					<!-- åº•éƒ¨æŒ‰é’®åŒºåŸŸ -->
					<view class="footer">
						<!-- ä¸Šä¸€é¢˜æŒ‰é’® -->
						<button class="custom-btn btn-prev" @tap="handlePrev">ä¸Šä¸€é¢˜</button>
						<!-- åŠ¨æ€æŒ‰é’®ï¼šæœ€åä¸€é¢˜å‰æ˜¾ç¤º"ä¸‹ä¸€é¢˜"ï¼Œæœ€åä¸€é¢˜æ˜¾ç¤º"æäº¤è¯•å·" -->
						<button v-if="questions.findIndex(q=>q.id === current) < questions.length - 1"
							class="custom-btn btn-next" @tap="handleNext">ä¸‹ä¸€é¢˜</button>
						<button v-else class="custom-btn btn-submit" @tap="handleSubmit">æäº¤è¯•å·</button>
					</view>
				</view>
			</view>
		</scroll-view>
	</view>
</template>

<script setup lang="uts">
	import { ref, computed, onMounted, onBeforeUnmount } from 'vue'
	import { dataList } from "@/assets/mock/simulate-v5.data.uts"
	import { Question } from "@/assets/type/exam.type.uts"

	// å½“å‰æ˜¾ç¤ºçš„é¢˜ç›®ID
	const current = ref('')
	// å·²ç­”é¢˜æ•°é‡
	const answered = ref(0)
	// ç”¨æˆ·ç­”æ¡ˆæ˜ å°„è¡¨ï¼ˆé¢˜ç›®ID -> ç­”æ¡ˆæ•°ç»„ï¼‰
	const userAnswers = ref<Map<string, string[]>>(new Map())
	// å½“å‰é¢˜ç›®çš„ç­”æ¡ˆæ•°ç»„
	const currentAnswers = ref<string[]>([])

	// è·å–å½“å‰é¢˜ç›®çš„ç”¨æˆ·ç­”æ¡ˆ
	const getCurrentUserAnswers = () => {
		const list = userAnswers.value.get(current.value)
		return (list !== null && Array.isArray(list)) ? list : []
	}

	// è€ƒè¯•æ—¶é•¿è®¾ç½®ï¼ˆç§’ï¼‰
	// const examDuration = 120 * 60 // å®é™…è€ƒè¯•æ—¶é—´ï¼ˆ2å°æ—¶ï¼‰
	const examDuration = 100 // æµ‹è¯•ç”¨æ—¶é—´ï¼ˆ100ç§’ï¼‰
	// å‰©ä½™æ—¶é—´ï¼ˆç§’ï¼‰
	const remainingTime = ref(examDuration)
	// è®¡æ—¶å™¨å¼•ç”¨
	let timer : number | null = null

	// è®¡ç®—å±æ€§ï¼šæ ¼å¼åŒ–æ˜¾ç¤ºæ—¶é—´ï¼ˆHH:MM:SSï¼‰
	const formattedTime = computed(() => {
		const hours = Math.floor(remainingTime.value / 3600)
		const minutes = Math.floor((remainingTime.value % 3600) / 60)
		const seconds = remainingTime.value % 60
		return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`
	})

	// ç­”é¢˜å¡å±•å¼€/æ”¶èµ·çŠ¶æ€
	const expanded = ref(false)
	// åˆ‡æ¢ç­”é¢˜å¡å±•å¼€çŠ¶æ€
	const toggleExpand = () => {
		expanded.value = !expanded.value
	}

	// é¢˜ç›®åˆ—è¡¨ï¼ˆä»mockæ•°æ®å¯¼å…¥ï¼‰
	const questions = ref<Question[]>(dataList)

	// è®¡ç®—å±æ€§ï¼šå½“å‰é¢˜ç›®å¯¹è±¡
	const currentQuestion = computed(() : Question => {
		const obj = questions.value.find(q => q.id === current.value)
		return obj === null ? questions.value[0] : obj
	})
	// è®¡ç®—å±æ€§ï¼šç­”é¢˜è¿›åº¦ç™¾åˆ†æ¯”
	const progress = computed(() => Math.round((answered.value / questions.value.length) * 100))

	// å½“å‰é¢˜ç›®çš„é¢˜å¹²/é€‰é¡¹/é€‰é¡¹å­—æ¯æ ‡è®°/ç±»å‹/åˆ†å€¼è®¡ç®—å±æ€§
	const stem = computed(() => currentQuestion.value.stem)
	const options = computed(() => currentQuestion.value.options)
	const optKey = computed(() => ['A', 'B', 'C', 'D', 'E', 'F', 'G'].slice(0, options.value.length))
	const questionType = computed(() => currentQuestion.value.type === 'single' ? 'å•é€‰é¢˜' : 'å¤šé€‰é¢˜')
	const questionScore = computed(() => `æœ¬é¢˜åˆ†å€¼: ${currentQuestion.value.score}åˆ†`)

	// åˆ¤æ–­æŒ‡å®šç´¢å¼•çš„é¢˜ç›®æ˜¯å¦å·²å›ç­”
	const isAnswered = (idx : number) => {
		const id = questions.value[idx].id
		const list = userAnswers.value.get(id)
		return list !== null && Array.isArray(list) && list.length > 0
	}

	// æ›´æ–°å·²ç­”é¢˜æ•°é‡ï¼ˆéå†ç­”æ¡ˆæ˜ å°„è¡¨ç»Ÿè®¡ï¼‰
	const updateAnsweredCount = () => {
		let num : number = 0
		userAnswers.value.forEach((value : string[]) => {
			if (value.length > 0) {
				num++;
			}
		})
		answered.value = num
	}

	// è·³è½¬åˆ°æŒ‡å®šç´¢å¼•çš„é¢˜ç›®
	const handleJump = (idx : number) => {
		current.value = questions.value[idx].id
		// åŠ è½½è¯¥é¢˜ç›®çš„ç”¨æˆ·ç­”æ¡ˆ
		currentAnswers.value = getCurrentUserAnswers()
	}

	// å¤„ç†é€‰é¡¹é€‰æ‹©
	const handleSelect = (key : string) => {
		// å•é€‰é¢˜å¤„ç†é€»è¾‘
		if (currentQuestion.value.type === 'single') {
			// ç›´æ¥æ›¿æ¢ä¸ºå½“å‰é€‰é¡¹
			currentAnswers.value = [key]
		} else {
			// å¤šé€‰é¢˜å¤„ç†é€»è¾‘ï¼šåˆ‡æ¢é€‰ä¸­çŠ¶æ€
			const index = currentAnswers.value.indexOf(key)
			if (index > -1) {
				// å·²é€‰ä¸­åˆ™ç§»é™¤
				currentAnswers.value.splice(index, 1)
			} else {
				// æœªé€‰ä¸­åˆ™æ·»åŠ 
				currentAnswers.value.push(key)
			}
		}

		// ä¿å­˜å½“å‰é¢˜ç›®ç­”æ¡ˆåˆ°æ˜ å°„è¡¨
		userAnswers.value.set(current.value, [...currentAnswers.value])
		// æ›´æ–°å·²ç­”é¢˜æ•°é‡ç»Ÿè®¡
		updateAnsweredCount()
	}

	// åˆ¤æ–­é€‰é¡¹æ˜¯å¦è¢«é€‰ä¸­
	const isSelected = (key : string) => {
		return currentAnswers.value.some(str => str === key)
	}

	// åˆ‡æ¢åˆ°ä¸Šä¸€é¢˜
	const handlePrev = () => {
		const index = questions.value.findIndex(q => q.id === current.value)
		if (index > 1) {
			handleJump(index - 1)
		}
	}

	// åˆ‡æ¢åˆ°ä¸‹ä¸€é¢˜
	const handleNext = () => {
		const index = questions.value.findIndex(q => q.id === current.value)
		if (index < questions.value.length) {
			handleJump(index + 1)
		}
	}

	// åœæ­¢è®¡æ—¶å™¨
	const stopTimer = () => {
		const currentTimer = timer
		if (currentTimer !== null) {
			clearInterval(currentTimer)
			timer = null
		}
	}

	// è€ƒè¯•æ—¶é—´ç»“æŸå¤„ç†
	const handleTimeout = () => {
		stopTimer()
		uni.showModal({
			title: 'æ—¶é—´åˆ°',
			content: 'ç³»ç»Ÿå·²è‡ªåŠ¨äº¤å·',
			confirmText: 'æŸ¥çœ‹æˆç»©',
			success: () => {
				// è¿™é‡Œå¯ä»¥è·³è½¬åˆ°æˆç»©é¡µé¢
			}
		})
	}

	// å¼€å§‹è®¡æ—¶å™¨ï¼ˆæ¯ç§’æ›´æ–°ï¼‰
	const startTimer = () => {
		if (timer !== null) return
		timer = setInterval(() => {
			remainingTime.value--
			if (remainingTime.value <= 0) {
				handleTimeout()
			}
		}, 1000)
	}

	// æäº¤è¯•å·å¤„ç†
	const handleSubmit = () => {
		stopTimer()
		uni.showModal({
			title: 'æç¤º',
			content: 'ç¡®è®¤æäº¤è¯•å·ï¼Ÿ',
			success: (res) => {
				if (res.confirm) {
					uni.showToast({ title: 'æäº¤æˆåŠŸ', icon: 'success' })
				} else {
					startTimer() // å–æ¶ˆæäº¤åˆ™é‡æ–°å¼€å§‹è®¡æ—¶
				}
			}
		})
	}

	/**
	 * é¡µé¢æŒ‚è½½å®Œæˆé’©å­
	 */
	onMounted(() => {
		// åˆå§‹åŒ–ç¬¬ä¸€é¢˜
		if (questions.value.length !== (0 as number)) {
			current.value = questions.value[0].id
			currentAnswers.value = getCurrentUserAnswers()
		}
		// å¼€å§‹è€ƒè¯•è®¡æ—¶
		startTimer()
	})

	/**
	 * é¡µé¢å¸è½½å‰é’©å­
	 */
	onBeforeUnmount(() => {
		// æ¸…ç†è®¡æ—¶å™¨
		stopTimer()
	})
</script>

<style>
	/* ä»…æ”¯æŒ flexï¼Œä¸»é¢˜è‰² #5250b3 */
	.page {
		flex: 1;
		background-color: #f5f7fa;
	}

	.page-scroll {
		flex: 1;
	}

	.page-scroll-view {
		padding: 16px;
		flex-direction: column;
	}

	.header {
		padding: 16px;
		background: linear-gradient(to bottom right, #5250b3, #3a3899);
		border-radius: 12px;
		margin-bottom: 16px;
	}

	.title-row {
		margin-bottom: 8px;
	}

	.title {
		color: #fff;
		font-size: 18px;
		font-weight: 700;
	}

	.info-row {
		flex-direction: row;
		justify-content: space-between;
		margin-bottom: 12px;
	}

	.info-row-text {
		color: #fff;
		font-size: 13px;
	}

	.progress-wrap {
		margin-top: 5px;
	}

	.progress-bar {
		height: 6px;
		width: 100%;
		background-color: #eee;
		border-radius: 3px;
	}

	.progress-fill {
		height: 100%;
		background-color: #999;
		border-radius: 3px;
	}

	.progress-info {
		flex-direction: row;
		justify-content: space-between;
		margin-top: 6px;
	}

	.progress-info-text {
		font-size: 12px;
		color: #fff;
	}

	/* ç­”é¢˜å¡ */
	.card {
		background-color: #fff;
		border-radius: 12px;
		margin-bottom: 16px;
		padding: 0 12px;
	}

	.card-header {
		flex-direction: row;
		justify-content: space-between;
		align-items: center;
		padding: 12px 0;
	}

	.card-title {
		font-size: 15px;
		font-weight: 700;
		color: #5250b3;
	}

	.arrow {
		font-size: 12px;
		transition: all 0.2s;
	}

	.arrow.up {
		transform: rotate(180deg);
	}

	.card-body {
		padding-bottom: 12px;
	}

	.grid {
		flex-direction: row;
		flex-wrap: wrap;
	}

	.btn {
		width: 36px;
		height: 36px;
		border-radius: 6px;
		border-width: 1px;
		align-items: center;
		justify-content: center;
		margin-right: 5px;
		margin-bottom: 5px;
		background-color: #f0f2f5;
		border-color: #e4e6eb;
	}

	.btn-answered {
		width: 36px;
		height: 36px;
		border-radius: 6px;
		border-width: 1px;
		align-items: center;
		justify-content: center;
		margin-right: 5px;
		margin-bottom: 5px;
		background-color: #d0d7ff;
		border-color: #b8c2ff;
	}

	.btn-current {
		width: 36px;
		height: 36px;
		border-radius: 6px;
		border-width: 1px;
		align-items: center;
		justify-content: center;
		margin-right: 5px;
		margin-bottom: 5px;
		background-color: #5250b3;
		border-color: #5250b3;
	}

	.btn-text {
		font-size: 14px;
		color: #333;
	}

	.btn-text-current {
		font-size: 14px;
		color: #fff;
	}

	.btn-text-answered {
		font-size: 14px;
		color: #2a3360;
	}

	/* é¢˜ç›®å¡ç‰‡ */
	.question-card {
		background-color: #fff;
		border-radius: 12px;
		padding: 16px;
	}

	.question-header {
		flex-direction: row;
		justify-content: space-between;
		margin-bottom: 16px;
		padding-bottom: 12px;
		border-bottom-width: 1px;
		border-bottom-color: #eee;
	}

	.type {
		background-color: #5250b3;
		color: #fff;
		padding: 2px 8px;
		border-radius: 12px;
		font-size: 12px;
	}

	.score {
		color: #ff6b6b;
		font-size: 13px;
		font-weight: 700;
	}

	.question-text {
		font-size: 16px;
		line-height: 24px;
		margin-bottom: 20px;
	}

	/* é€‰é¡¹ */
	.options {
		margin-bottom: 20px;
	}

	/* å¤šé€‰é¢˜é€‰ä¸­æ ‡è®° */
	.multi-select-mark {
		position: absolute;
		right: 12px;
		width: 20px;
		height: 20px;
		border-radius: 10px;
		background-color: #5250b3;
	}

	.multi-select-mark-text {
		color: white;
		text-align: center;
		line-height: 20px;
		font-size: 12px;
	}

	.option {
		flex-direction: row;
		align-items: center;
		padding: 14px;
		flex: 1;
		box-sizing: border-box;
		margin-bottom: 10px;
		border-radius: 8px;
		background-color: #f9fafc;
		border-width: 1px;
		border-color: #e4e6eb;
		position: relative;
	}

	.option.selected {
		background-color: #f0f3ff;
		border-color: #b8c2ff;
	}

	.marker {
		width: 24px;
		height: 24px;
		border-radius: 12px;
		background-color: #e4e6eb;
		align-items: center;
		justify-content: center;
		margin-right: 12px;
		flex-shrink: 0;
	}

	.marker-text {
		font-weight: 700;
		font-size: 13px;
	}

	.option.selected .marker {
		background-color: #5250b3;
	}

	.option.selected .marker-text {
		color: #fff;
	}

	.text {
		font-size: 15px;
		color: #333;
		flex: 1;
	}

	/* åº•éƒ¨æŒ‰é’® */
	.footer {
		flex-direction: row;
	}

	.custom-btn {
		flex: 1;
		padding: 8px 0;
		border-radius: 8px;
		font-size: 15px;
		font-weight: 700;
		text-align: center;
		border-width: 0;
	}

	.btn-prev {
		background-color: #f0f2f5;
		color: #606266;
		margin-right: 5px;
	}

	.btn-next {
		background-color: #5250b3;
		color: #fff;
	}

	.btn-submit {
		background: linear-gradient(to bottom right, #5250b3, #3a3899);
		color: #fff;
	}
</style>